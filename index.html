<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X402 AI Payment Assistant - Windows XP Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Tahoma", "MS Sans Serif", sans-serif;
            background: #5A7EDC;
            padding: 20px;
            overflow-x: hidden;
        }

        .desktop {
            max-width: 1200px;
            margin: 0 auto;
        }

        .window {
            background: #ECE9D8;
            border: 3px solid;
            border-color: #DFDFDF #808080 #808080 #DFDFDF;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .title-bar {
            background: linear-gradient(180deg, #0997FF 0%, #0053EE 8%, #0050EE 40%, #06F 88%, #06F 93%, #005BFF 95%, #003DD7 96%, #003DD7 100%);
            padding: 3px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .title-bar-text {
            color: white;
            font-weight: bold;
            font-size: 13px;
            padding-left: 5px;
            display: flex;
            align-items: center;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }

        .title-bar-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }

        .title-bar-controls {
            display: flex;
            gap: 2px;
        }

        .title-bar-button {
            width: 21px;
            height: 21px;
            background: linear-gradient(180deg, #F1F0F8 0%, #CBC8D7 100%);
            border: 1px solid;
            border-color: #FFFFFF #000000 #000000 #FFFFFF;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }

        .title-bar-button:active {
            border-color: #000000 #FFFFFF #FFFFFF #000000;
        }

        .window-body {
            padding: 10px;
        }

        .ascii-art {
            font-family: "Courier New", monospace;
            font-size: 10px;
            line-height: 1.1;
            color: #000080;
            background: white;
            padding: 10px;
            border: 2px inset;
            margin-bottom: 10px;
            overflow-x: auto;
            white-space: pre;
        }

        .status-bar {
            border-top: 1px solid #808080;
            padding: 3px 5px;
            font-size: 11px;
            display: flex;
            gap: 10px;
            background: #ECE9D8;
        }

        .status-item {
            border: 1px solid;
            border-color: #808080 #DFDFDF #DFDFDF #808080;
            padding: 2px 5px;
            flex: 1;
        }

        .chat-container {
            background: white;
            border: 2px inset;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            font-family: "Courier New", monospace;
            font-size: 12px;
        }

        .message {
            margin-bottom: 15px;
            padding: 8px;
            border-radius: 0;
        }

        .message.user {
            background: #D4D0C8;
            border: 1px solid;
            border-color: #FFFFFF #808080 #808080 #FFFFFF;
        }

        .message.assistant {
            background: #FFF;
            border: 2px solid #000080;
            margin-left: 20px;
        }

        .message.system {
            background: #FFFFCC;
            border: 1px dashed #FF0000;
            font-size: 10px;
            color: #008000;
        }

        .message.payment {
            background: #E0FFE0;
            border: 1px solid #00AA00;
            font-size: 10px;
            color: #006600;
            font-family: "Courier New", monospace;
        }

        .input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .input-field {
            flex: 1;
            padding: 4px;
            border: 2px inset;
            font-family: "Tahoma", sans-serif;
            font-size: 12px;
        }

        .xp-button {
            background: linear-gradient(180deg, #EFF4FF 0%, #D0E3FF 50%, #7EB4FF 51%, #00A5FF 100%);
            border: 1px solid #003C74;
            border-radius: 3px;
            padding: 6px 15px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            box-shadow: inset 0 0 2px rgba(255,255,255,0.5);
        }

        .xp-button:hover {
            background: linear-gradient(180deg, #F0F8FF 0%, #D8E8FF 50%, #8CBDFF 51%, #2AB4FF 100%);
        }

        .xp-button:active {
            background: linear-gradient(180deg, #7EB4FF 0%, #00A5FF 50%, #D0E3FF 51%, #EFF4FF 100%);
        }

        .xp-button:disabled {
            background: #D4D0C8;
            color: #808080;
            cursor: not-allowed;
        }

        .payment-panel {
            background: #C0C0C0;
            border: 2px outset;
            padding: 10px;
            margin-bottom: 10px;
        }

        .payment-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            background: black;
            color: #00FF00;
            font-family: "Courier New", monospace;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .payment-details {
            background: #000;
            color: #0F0;
            padding: 10px;
            font-family: "Courier New", monospace;
            font-size: 10px;
            margin-top: 10px;
            border: 1px solid #0F0;
        }

        .payment-line {
            margin: 2px 0;
        }

        .blinking {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            border: 1px solid #003C74;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: repeating-linear-gradient(
                45deg,
                #0066CC,
                #0066CC 10px,
                #0080FF 10px,
                #0080FF 20px
            );
            width: 0%;
            transition: width 0.3s;
        }


        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted black;
        }

        a {
            color: #0000EE;
            text-decoration: underline;
        }

        a:visited {
            color: #551A8B;
        }

        .timestamp {
            color: #808080;
            font-size: 10px;
        }

        .matrix-effect {
            animation: matrix 0.5s ease-in-out;
        }

        @keyframes matrix {
            0% { text-shadow: 0 0 10px #0F0; }
            50% { text-shadow: 0 0 20px #0F0, 0 0 30px #0F0; }
            100% { text-shadow: 0 0 10px #0F0; }
        }

        .wallet-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(180deg, #EFF4FF 0%, #D0E3FF 50%, #7EB4FF 51%, #00A5FF 100%);
            border: 2px solid #003C74;
            border-radius: 5px;
            padding: 8px 16px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
            font-family: "Tahoma", sans-serif;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-button:hover {
            background: linear-gradient(180deg, #F0F8FF 0%, #D8E8FF 50%, #8CBDFF 51%, #2AB4FF 100%);
        }

        .wallet-button.connected {
            background: linear-gradient(180deg, #E0FFE0 0%, #B0FFB0 50%, #80FF80 51%, #50FF50 100%);
            border-color: #008000;
        }

        .wallet-icon {
            width: 20px;
            height: 20px;
        }

        .wallet-address {
            font-family: "Courier New", monospace;
            font-size: 11px;
        }

        .wallet-popup {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 999;
            background: #ECE9D8;
            border: 3px solid;
            border-color: #DFDFDF #808080 #808080 #DFDFDF;
            padding: 15px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            display: none;
            min-width: 250px;
        }

        .wallet-popup.show {
            display: block;
        }

        .wallet-info-line {
            margin: 5px 0;
            font-size: 11px;
            font-family: "Tahoma", sans-serif;
        }

        .wallet-balance {
            color: #008000;
            font-weight: bold;
        }

        .network-badge {
            display: inline-block;
            background: #0066CC;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .network-badge.wrong {
            background: #CC0000;
        }
    </style>
</head>
<body>
    <!-- Wallet Connection Button -->
    <button class="wallet-button" id="walletButton" onclick="toggleWallet()">
        <span class="wallet-icon">ğŸ’³</span>
        <span id="walletButtonText">Connect Wallet</span>
    </button>

    <!-- Wallet Info Popup -->
    <div class="wallet-popup" id="walletPopup">
        <div class="wallet-info-line">
            <strong>Network:</strong> <span class="network-badge" id="networkBadge">Not Connected</span>
        </div>
        <div class="wallet-info-line">
            <strong>Address:</strong><br>
            <span class="wallet-address" id="walletAddressDisplay">-</span>
        </div>
        <div class="wallet-info-line">
            <strong>Balance:</strong> <span class="wallet-balance" id="walletBalanceDisplay">- BNB</span>
        </div>
        <div class="wallet-info-line" style="margin-top: 10px;">
            <button class="xp-button" onclick="disconnectWallet()" style="width: 100%;">Disconnect</button>
        </div>
    </div>

    <div class="desktop">
        <!-- ASCII Art Header Window -->
        <div class="window">
            <div class="title-bar">
                <div class="title-bar-text">
                    <span class="title-bar-icon">ğŸ’¾</span>
                    X402 Protocol Visualizer
                </div>
                <div class="title-bar-controls">
                    <button class="title-bar-button">_</button>
                    <button class="title-bar-button">â–¡</button>
                    <button class="title-bar-button">Ã—</button>
                </div>
            </div>
            <div class="window-body">
                <div class="ascii-art" id="asciiArt">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•‘
â•‘  â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ•â•â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•   â•‘
â•‘   â•šâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘      â•‘
â•‘   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•     â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘      â•‘
â•‘  â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘      â•‘
â•‘  â•šâ•â•  â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•    â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•    â•šâ•â•      â•‘
â•‘                                                                              â•‘
â•‘              .:*~*:._.:*~*:. AI PAYMENT ASSISTANT .:*~*:._.:*~*:.            â•‘
â•‘                                                                              â•‘
â•‘            ã€Œ Automated Micropayment Protocol for AI Services ã€            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                </div>
            </div>
        </div>

        <!-- Main Chat Window -->
        <div class="window">
            <div class="title-bar">
                <div class="title-bar-text">
                    <span class="title-bar-icon">ğŸ¤–</span>
                    X402 AI Chat Assistant v2.1.402
                </div>
                <div class="title-bar-controls">
                    <button class="title-bar-button">_</button>
                    <button class="title-bar-button">â–¡</button>
                    <button class="title-bar-button">Ã—</button>
                </div>
            </div>
            <div class="window-body">
                <!-- Payment Status Panel -->
                <div class="payment-panel">
                    <div class="payment-status">
                        <span class="blinking">â–ˆ</span>
                        <span id="paymentStatus">X402 PROTOCOL: STANDBY | GATEWAY: ONLINE | AUTO-PAY: ENABLED</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="chat-container" id="chatContainer">
                    <div class="message system">
                        â•â•â• SYSTEM INITIALIZATION â•â•â•<br>
                        [OK] X402 Protocol Handler Loaded<br>
                        [OK] Payment Gateway Connected<br>
                        [OK] AI Neural Interface Active<br>
                        [OK] Cryptographic Handshake Complete<br>
                        [OK] Smart Contract Verification: PASSED<br>
                        <br>
                        âš¡ Ready to process requests with X402 micropayments âš¡<br>
                        <span class="timestamp">System Time: <span id="systemTime"></span></span>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="input-group">
                    <input type="text" class="input-field" id="userInput" 
                           placeholder="Type your message... (Each message costs ~0.00001 BNB)" 
                           onkeypress="handleKeyPress(event)">
                    <button class="xp-button" onclick="sendMessage()" id="sendBtn">â–¶ SEND & PAY</button>
                    <button class="xp-button" onclick="clearChat()">ğŸ—‘ CLEAR</button>
                </div>
            </div>
            <div class="status-bar">
                <div class="status-item">ğŸ” TX: <span id="lastTxId">Waiting...</span></div>
                <div class="status-item">ğŸ“¡ Status: <span id="connectionStatus">Connected</span></div>
                <div class="status-item">ğŸ’° Spent: <span id="totalSpent">0.000000</span> BNB</div>
            </div>
        </div>

        <!-- Info Window -->
        <div class="window">
            <div class="title-bar">
                <div class="title-bar-text">
                    <span class="title-bar-icon">â„¹ï¸</span>
                    About X402 Protocol
                </div>
                <div class="title-bar-controls">
                    <button class="title-bar-button">_</button>
                    <button class="title-bar-button">â–¡</button>
                    <button class="title-bar-button">Ã—</button>
                </div>
            </div>
            <div class="window-body">
                <p style="font-size: 11px; margin-bottom: 10px;">
                    <strong>X402 Protocol</strong> is a decentralized micropayment system for AI services. 
                    Built on BNB Smart Chain, each query automatically processes BNB payment 
                    through the X402 gateway and routes your request to AI models worldwide via 
                    secure blockchain transactions.
                </p>
                <div class="ascii-art" style="font-size: 8px;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [USER] â†’ X402 Gateway â†’ Smart Contract â†’ [AI MODEL]   â”‚
â”‚     â†‘          â†“              â†“               â†“         â”‚
â”‚     â”‚      Verify TX      Deduct Fee      Generate     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Response â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                </div>
                <div class="payment-details">
                    <div class="payment-line">Protocol Version: X402/1.0</div>
                    <div class="payment-line">Network: BNB Smart Chain</div>
                    <div class="payment-line">Payment Token: BNB</div>
                    <div class="payment-line">Chain ID: 56</div>
                    <div class="payment-line">Gas Fee: ~0.0001 BNB per transaction</div>
                    <div class="payment-line">Confirmation Time: ~3s</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ethers.js Library (from jsDelivr CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // Firebase Cloud Function URL (å·²éƒ¨ç½²çš„åç«¯åœ°å€)
        const FIREBASE_FUNCTION_URL = 'https://us-central1-big-pig-38efe.cloudfunctions.net/chatWithAI';

        // BNB Chain Configuration (BSC)
        const BSC_CHAIN_ID = '0x38'; // 56 in hex
        const BSC_CHAIN_ID_DECIMAL = 56;
        const BSC_RPC_URL = 'https://bsc-dataseed1.binance.org';
        // BNB is native token, no contract address needed

        // Wallet State
        let provider = null;
        let signer = null;
        let userAddress = null;
        let bnbBalance = 0;

        let conversationHistory = [];
        let totalTokens = 0;
        let totalSpent = 0;
        let transactionCount = 0;

        // Update system time
        function updateTime() {
            const now = new Date();
            const timeElement = document.getElementById('systemTime');
            if (timeElement) {
                timeElement.textContent = now.toLocaleString('zh-CN');
            }
        }
        
        // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†æ‰§è¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                updateTime();
                setInterval(updateTime, 1000);
            });
        } else {
            updateTime();
            setInterval(updateTime, 1000);
        }

        // Process X402 payment transaction
        function processPaymentFlow(txId, amount) {
            const statuses = [
                'X402: Initiating payment request...',
                'X402: Broadcasting to network...',
                'X402: Awaiting confirmation... [1/3]',
                'X402: Smart contract executed [2/3]',
                'X402: Transaction confirmed [3/3]',
                'X402: PAYMENT COMPLETE âœ“'
            ];
            
            let index = 0;
            const interval = setInterval(() => {
                document.getElementById('paymentStatus').textContent = statuses[index];
                document.getElementById('progressBar').style.width = ((index + 1) * 16.6) + '%';
                
                index++;
                if (index >= statuses.length) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('paymentStatus').textContent = 
                            'X402 PROTOCOL: STANDBY | GATEWAY: ONLINE | AUTO-PAY: ENABLED';
                        document.getElementById('progressBar').style.width = '0%';
                    }, 1000);
                }
            }, 400);
        }

        // Generate transaction ID
        function generateTxId() {
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            return `X402-${timestamp}-${random}`;
        }

        // Add message to chat
        function addMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const prefix = role === 'user' ? 'ğŸ‘¤ USER' : 'ğŸ¤– AI ASSISTANT';
            
            messageDiv.innerHTML = `<strong>${prefix}</strong> [${timestamp}]<br>${escapeHtml(content)}`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Add payment confirmation message
        function addPaymentMessage(txId, amount, status) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message payment matrix-effect';
            messageDiv.innerHTML = `
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—<br>
                â•‘  X402 PAYMENT CONFIRMATION                â•‘<br>
                â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£<br>
                â•‘  Transaction ID: ${txId}  â•‘<br>
                â•‘  Network: BNB Chain (Chain ID: 56)        â•‘<br>
                â•‘  Amount: ${amount} BNB                       â•‘<br>
                â•‘  Status: ${status}                   â•‘<br>
                â•‘  Gas Fee: ~0.0001 BNB                     â•‘<br>
                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Add system message
        function addSystemMessage(content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `âš¡ SYSTEM: ${escapeHtml(content)}`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Generate transaction details
            const txId = generateTxId();
            transactionCount++;
            
            // Disable input
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('connectionStatus').textContent = 'Processing...';
            document.getElementById('lastTxId').textContent = txId;

            // Add user message
            addMessage('user', message);
            conversationHistory.push({ role: 'user', content: message });
            input.value = '';

            // Process X402 payment
            addSystemMessage('ğŸ’¸ Initiating X402 payment transaction...');
            
            // Calculate USDC transaction cost (based on AI tokens)
            const transactionCost = (0.00005 + Math.random() * 0.0001).toFixed(6);
            processPaymentFlow(txId, transactionCost);

            try {
                // Call Firebase Function
                const response = await fetch(FIREBASE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: conversationHistory,
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error occurred');
                }

                // Extract response
                const assistantMessage = data.response;
                const x402Data = data.x402;
                
                // Update spending
                totalTokens += data.usage.total_tokens;
                totalSpent += parseFloat(x402Data.amount);
                
                document.getElementById('totalSpent').textContent = totalSpent.toFixed(6);
                
                // Show payment confirmation
                addPaymentMessage(x402Data.transaction_id, x402Data.amount, 'âœ“ CONFIRMED');
                
                // Add assistant response
                conversationHistory.push({ role: 'assistant', content: assistantMessage });
                setTimeout(() => {
                    addMessage('assistant', assistantMessage);
                }, 800);

            } catch (error) {
                console.error('Error:', error);
                addSystemMessage(`âŒ ERROR: ${error.message}`);
                addPaymentMessage(txId, transactionCost, 'âœ— FAILED');
                document.getElementById('progressBar').style.width = '0%';
            } finally {
                // Re-enable input
                setTimeout(() => {
                    input.disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('connectionStatus').textContent = 'Connected';
                    input.focus();
                }, 1500);
            }
        }

        // Clear chat
        function clearChat() {
            if (confirm('Clear all chat history?')) {
                document.getElementById('chatContainer').innerHTML = '';
                conversationHistory = [];
                totalTokens = 0;
                totalSpent = 0;
                document.getElementById('totalSpent').textContent = '0.000000';
                addSystemMessage('Chat history cleared. System ready.');
            }
        }

        // ============ Wallet Connection Functions ============

        async function toggleWallet() {
            if (userAddress) {
                // Show/hide wallet popup
                const popup = document.getElementById('walletPopup');
                popup.classList.toggle('show');
            } else {
                await connectWallet();
            }
        }

        async function connectWallet() {
            try {
                // Check if ethers.js is loaded
                if (typeof ethers === 'undefined') {
                    alert('Ethers.js library failed to load. Please refresh the page!');
                    return;
                }

                // Check if wallet is installed
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install OKX Wallet or MetaMask to use this feature!');
                    return;
                }

                addSystemMessage('ğŸ”— Connecting to wallet...');

                // Request account access first
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) {
                    throw new Error('No accounts found');
                }

                // Check current network before creating provider
                const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                const currentChainIdDecimal = parseInt(currentChainId, 16);

                // Switch network if needed
                if (currentChainIdDecimal !== BSC_CHAIN_ID_DECIMAL) {
                    addSystemMessage('âš ï¸ Wrong network detected. Switching to BNB Chain...');
                    await switchToBSCNetwork();
                    // Wait a bit for network to stabilize
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } else {
                    addSystemMessage('âœ… Already on BNB Chain');
                }

                // Create provider after network is correct
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Update UI
                await updateWalletUI();
                
                // Listen for account changes
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);

                addSystemMessage(`âœ… Wallet connected: ${formatAddress(userAddress)}`);
                
            } catch (error) {
                console.error('Wallet connection error:', error);
                if (error.code === 4001) {
                    addSystemMessage('âŒ User rejected the connection');
                } else if (error.code === -32002) {
                    addSystemMessage('âš ï¸ Please check your wallet - connection request is pending');
                } else {
                    addSystemMessage(`âŒ Failed to connect wallet: ${error.message}`);
                }
            }
        }

        async function switchToBSCNetwork() {
            try {
                // Try to switch to BNB Chain (BSC)
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BSC_CHAIN_ID }],
                });
                addSystemMessage('âœ… Switched to BNB Chain');
            } catch (switchError) {
                // If BSC network is not added, add it
                if (switchError.code === 4902) {
                    try {
                        addSystemMessage('ğŸ“¡ Adding BNB Chain to your wallet...');
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BSC_CHAIN_ID,
                                chainName: 'BNB Smart Chain',
                                nativeCurrency: {
                                    name: 'BNB',
                                    symbol: 'BNB',
                                    decimals: 18
                                },
                                rpcUrls: [BSC_RPC_URL],
                                blockExplorerUrls: ['https://bscscan.com']
                            }],
                        });
                        addSystemMessage('âœ… BNB Chain added successfully');
                    } catch (addError) {
                        throw new Error('Failed to add BNB Chain');
                    }
                } else if (switchError.code === 4001) {
                    throw new Error('User rejected network switch');
                } else {
                    throw switchError;
                }
            }
        }

        async function updateWalletUI() {
            if (!userAddress) return;

            // Update button
            const button = document.getElementById('walletButton');
            const buttonText = document.getElementById('walletButtonText');
            button.classList.add('connected');
            buttonText.textContent = formatAddress(userAddress);

            // Update address display
            document.getElementById('walletAddressDisplay').textContent = userAddress;

            // Check network
            const network = await provider.getNetwork();
            const networkBadge = document.getElementById('networkBadge');
            if (network.chainId === BSC_CHAIN_ID_DECIMAL) {
                networkBadge.textContent = 'BNB Chain (56)';
                networkBadge.classList.remove('wrong');
            } else {
                networkBadge.textContent = `Wrong Network (${network.chainId})`;
                networkBadge.classList.add('wrong');
            }

            // Get BNB balance
            await updateBNBBalance();
        }

        async function updateBNBBalance() {
            try {
                // Get BNB balance (native token)
                const balance = await provider.getBalance(userAddress);
                bnbBalance = ethers.utils.formatEther(balance);
                document.getElementById('walletBalanceDisplay').textContent = 
                    parseFloat(bnbBalance).toFixed(4) + ' BNB';
            } catch (error) {
                console.error('Error fetching BNB balance:', error);
                document.getElementById('walletBalanceDisplay').textContent = '- BNB';
            }
        }

        function disconnectWallet() {
            provider = null;
            signer = null;
            userAddress = null;
            bnbBalance = 0;

            // Update UI
            const button = document.getElementById('walletButton');
            const buttonText = document.getElementById('walletButtonText');
            button.classList.remove('connected');
            buttonText.textContent = 'Connect Wallet';

            // Hide popup
            document.getElementById('walletPopup').classList.remove('show');

            // Reset displays
            document.getElementById('walletAddressDisplay').textContent = '-';
            document.getElementById('walletBalanceDisplay').textContent = '- BNB';
            document.getElementById('networkBadge').textContent = 'Not Connected';

            addSystemMessage('ğŸ”Œ Wallet disconnected');
        }

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else if (accounts[0] !== userAddress) {
                window.location.reload();
            }
        }

        function handleChainChanged(chainId) {
            window.location.reload();
        }

        function formatAddress(address) {
            return address.substring(0, 6) + '...' + address.substring(address.length - 4);
        }

        // Auto-connect if previously connected
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.error('Auto-connect error:', error);
                }
            }
        });
    </script>
</body>
</html>
